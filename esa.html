<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="https://cdn.cydiaa.com/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESA 监控大屏</title>
    <script src="https://edgeone.cydiaa.com/?url=https://cdn.tailwindcss.com"></script>
    <script src="https://edgeone.cydiaa.com/?url=https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://edgeone.cydiaa.com/?url=https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/world.js"></script>
    
    <style>
        /* 引入 Inter 字体 */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    
    <script>
        // 定义 Tailwind CSS 配置，用于 Shadcn/UI 的颜色和圆角变量
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: { DEFAULT: "hsl(var(--primary))", foreground: "hsl(var(--primary-foreground))" },
                        secondary: { DEFAULT: "hsl(var(--secondary))", foreground: "hsl(var(--secondary-foreground))" },
                        destructive: { DEFAULT: "hsl(var(--destructive))", foreground: "hsl(var(--destructive-foreground))" },
                        muted: { DEFAULT: "hsl(var(--muted))", foreground: "hsl(var(--muted-foreground))" },
                        accent: { DEFAULT: "hsl(var(--accent))", foreground: "hsl(var(--accent-foreground))" },
                        popover: { DEFAULT: "hsl(var(--popover))", foreground: "hsl(var(--popover-foreground))" },
                        card: { DEFAULT: "hsl(var(--card))", foreground: "hsl(var(--card-foreground))" },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                },
            },
        }
    </script>

    <style>
        /* Shadcn/UI 样式变量 */
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-8">
    <!-- Loading Progress Bar -->
    <div id="loading-progress-container" class="fixed top-0 left-0 w-full h-1 z-50 bg-transparent pointer-events-none">
        <div id="loading-progress-bar" class="h-full bg-blue-500 transition-all duration-300 ease-out w-0"></div>
    </div>

    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Header -->
        <div class="flex items-center justify-between">
            <div>
                <h1 id="page-header" class="text-3xl font-bold tracking-tight text-slate-900">阿里云ESA 监控大屏</h1>
                <p class="text-muted-foreground mt-1">阿里云ESA 站点流量与请求量分析</p>
            </div>
        </div>

        <!-- Time Controls -->
        <div class="flex flex-wrap items-center gap-4 bg-white p-4 rounded-xl border shadow-sm">
            <div class="flex items-center space-x-2">
                <label for="timeRange" class="text-sm font-medium">时间范围:</label>
                <select id="timeRange" onchange="handleTimeRangeChange()" class="h-9 w-[180px] rounded-md border border-slate-200 bg-white px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-slate-900">
                    <option value="30min">近 30 分钟</option>
                    <option value="1h">近 1 小时</option>
                    <option value="6h">近 6 小时</option>
                    <option value="today">今日</option>
                    <option value="yesterday">昨日</option>
                    <option value="3d">近 3 天</option>
                    <option value="7d">近 7 天</option>
                    <option value="14d">近 14 天</option>
                    <option value="31d">近 31 天</option>
                    <option value="custom">自定义</option>
                </select>
            </div>
            <!-- Custom Time Inputs -->
            <div id="customTimeInputs" class="hidden flex-wrap items-center gap-2 mt-2 w-full sm:w-auto">
                <div class="flex items-center space-x-1">
                    <input type="number" id="customDays" placeholder="0" class="h-8 w-16 rounded-md border border-slate-200 px-2 text-sm" min="0" max="31">
                    <span class="text-xs">天</span>
                </div>
                <div class="flex items-center space-x-1">
                    <input type="number" id="customHours" placeholder="0" class="h-8 w-16 rounded-md border border-slate-200 px-2 text-sm" min="0" max="23">
                    <span class="text-xs">小时</span>
                </div>
                <div class="flex items-center space-x-1">
                    <input type="number" id="customMinutes" placeholder="0" class="h-8 w-16 rounded-md border border-slate-200 px-2 text-sm" min="0" max="59">
                    <span class="text-xs">分</span>
                </div>
                <div class="flex items-center space-x-1">
                    <input type="number" id="customSeconds" placeholder="0" class="h-8 w-16 rounded-md border border-slate-200 px-2 text-sm" min="0" max="59">
                    <span class="text-xs">秒</span>
                </div>
                <button onclick="refreshData()" class="h-8 px-3 bg-slate-900 text-white rounded-md text-xs hover:bg-slate-800">应用</button>
                <span id="timeRangeError" class="text-red-500 text-xs font-medium ml-2"></span>
            </div>
            <div class="flex items-center space-x-2">
                <label for="interval" class="text-sm font-medium">粒度:</label>
                <select id="interval" onchange="refreshData()" class="h-9 w-[180px] rounded-md border border-slate-200 bg-white px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-slate-900">
                    <option value="60" selected>自动</option>
                    <option value="60">1 分钟</option>
                    <option value="300">5 分钟</option>
                    <option value="3600">1 小时</option>
                    <option value="86400">1 天</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="zoneId" class="text-sm font-medium">选择站点:</label>
                <select id="zoneId" onchange="refreshData()" class="h-9 w-[240px] rounded-md border border-slate-200 bg-white px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-slate-900">
                     <option value="">全部站点</option>
                </select>
            </div>
        </div>

        <!-- Main Content -->
        <div class="space-y-8">
            <!-- Section 1: Traffic (流量) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-slate-800 flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    流量分析 (Traffic)
                </h2>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                    <!-- 总流量 (Traffic) Card -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">总流量</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="Traffic">加载中...</div> 
                            <p class="text-xs text-muted-foreground mt-1">网站总流量</p>
                        </div>
                    </div>
                    <!-- 客户端请求流量 (RequestTraffic) Card -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">客户端请求流量</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="RequestTraffic">加载中...</div> 
                            <p class="text-xs text-muted-foreground mt-1">客户端请求消耗的流量</p>
                        </div>
                    </div>
                    <!-- 客户端请求数 (Requests) Card -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">客户端请求数</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="Requests">加载中...</div> 
                            <p class="text-xs text-muted-foreground mt-1">客户端的总请求次数</p>
                        </div>
                    </div>
                    <!-- 页面浏览量 (PageView) Card -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">页面浏览量</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="PageView">加载中...</div> 
                            <p class="text-xs text-muted-foreground mt-1">页面总访问量 (通常指HTML文档请求)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 全局变量和配置 ---
        const metricsConfig = {
            bytesMetrics: ['Traffic', 'RequestTraffic'],
            countMetrics: ['PageView', 'Requests'],
            fieldNames: ['Traffic', 'Requests', 'RequestTraffic', 'PageView'],
            dimension: ['ALL']
        };

        let currentRequests = []; // 跟踪当前请求
        let requestCount = 0;    // 已完成的请求数
        let totalRequests = 0;   // 总请求数
        let refreshDebounceTimer = null; // 防抖定时器

        // --- 辅助函数：加载进度条 ---
        function initProgressBar() {
            const progressBar = document.getElementById('loading-progress-bar');
            progressBar.style.width = '0%';
            progressBar.classList.remove('opacity-0');
            requestCount = 0;
        }

        function updateProgressBar() {
            const progressBar = document.getElementById('loading-progress-bar');
            requestCount++;
            const progress = (requestCount / totalRequests) * 100;
            progressBar.style.width = `${Math.min(progress, 95)}%`;
            
            // 所有请求完成
            if (requestCount >= totalRequests) {
                setTimeout(() => {
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        progressBar.classList.add('opacity-0');
                        progressBar.style.width = '0%';
                    }, 300);
                }, 200);
            }
        }

        // --- 日期和时间处理函数 ---
        function formatDate(date) {
            return date.toISOString().slice(0, 19) + 'Z';
        }

        function calculateTimeRange() {
            const range = document.getElementById('timeRange').value;
            const now = new Date();
            let endTime = new Date(now);
            let startTime;
        
            switch(range) {
                case '30min': startTime = new Date(now.getTime() - 30 * 60 * 1000); break;
                case '1h': startTime = new Date(now.getTime() - 1 * 60 * 60 * 1000); break;
                case '6h': startTime = new Date(now.getTime() - 6 * 60 * 60 * 1000); break;
                case 'today': 
                    startTime = new Date(now);
                    startTime.setHours(0, 0, 0, 0);
                    break;
                case 'yesterday':
                    startTime = new Date(now);
                    startTime.setDate(now.getDate() - 1);
                    startTime.setHours(0, 0, 0, 0);
                    
                    endTime = new Date(now);
                    endTime.setDate(now.getDate() - 1);
                    endTime.setHours(23, 59, 59, 999);
                    break;
                case '3d': startTime = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000); break;
                case '7d': startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case '14d': startTime = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000); break;
                case '31d': startTime = new Date(now.getTime() - 31 * 24 * 60 * 60 * 1000); break;
                case 'custom':
                    const days = parseInt(document.getElementById('customDays').value) || 0;
                    const hours = parseInt(document.getElementById('customHours').value) || 0;
                    const minutes = parseInt(document.getElementById('customMinutes').value) || 0;
                    const seconds = parseInt(document.getElementById('customSeconds').value) || 0;
                    
                    let totalMs = ((days * 24 * 60 * 60) + (hours * 60 * 60) + (minutes * 60) + seconds) * 1000;
                    const maxMs = 31 * 24 * 60 * 60 * 1000;
                    const errorEl = document.getElementById('timeRangeError');
        
                    if (totalMs > maxMs) {
                        if (errorEl) errorEl.innerText = '自定义时间范围不能超过 31 天，已自动为您调整为 31 天。';
                        totalMs = maxMs;
                    } else {
                        if (errorEl) errorEl.innerText = '';
                    }
        
                    if (totalMs > 0) {
                        startTime = new Date(now.getTime() - totalMs);
                    } else {
                        startTime = new Date(now.getTime() - 60 * 60 * 1000);
                    }
                    break;
                default: 
                    startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    break;
            }
        
            return {
                startTime: formatDate(startTime),
                endTime: formatDate(endTime)
            };
        }

        // --- 数据格式化函数 ---
        function formatBytes(bytes) {
            if (typeof bytes !== 'number' || isNaN(bytes)) return 'N/A';
            if (bytes === 0) return '0 B';
            
            const k = 1000;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB']; 
            
            const absoluteBytes = Math.abs(bytes);
            const sign = bytes < 0 ? '-' : '';

            const i = Math.floor(Math.log(absoluteBytes) / Math.log(k));
            const clampedIndex = Math.max(0, Math.min(i, sizes.length - 1));
            
            return sign + parseFloat((absoluteBytes / Math.pow(k, clampedIndex)).toFixed(2)) + ' ' + sizes[clampedIndex];
        }

        function getBestCountUnit(maxValue) {
            if (typeof maxValue !== 'number' || isNaN(maxValue)) return { unit: 'N/A', divisor: 1 };
            
            if (maxValue < 1000) return { unit: '次', divisor: 1 };
            if (maxValue < 10000) return { unit: '千次', divisor: 1000 };
            if (maxValue < 100000000) return { unit: '万次', divisor: 10000 };
            return { unit: '亿次', divisor: 100000000 };
        }

        function formatCount(value) {
            if (typeof value !== 'number' || isNaN(value)) return 'N/A';
            
            const { unit, divisor } = getBestCountUnit(value);
            if (divisor === 1) {
                return value.toLocaleString() + ' ' + unit;
            }
            return (value / divisor).toFixed(2).toLocaleString() + ' ' + unit;
        }
		
        // --- 交互及数据获取逻辑 ---
        function toggleCustomTimeInputs() {
            const timeRangeSelect = document.getElementById('timeRange');
            const customInputsDiv = document.getElementById('customTimeInputs');
            if (timeRangeSelect.value === 'custom') {
                customInputsDiv.classList.remove('hidden');
                customInputsDiv.classList.add('flex');
            } else {
                customInputsDiv.classList.add('hidden');
                customInputsDiv.classList.remove('flex');
                document.getElementById('timeRangeError').innerText = '';
            }
        }

        function handleTimeRangeChange() {
            toggleCustomTimeInputs();
            // 防抖处理，避免快速切换时频繁请求
            clearTimeout(refreshDebounceTimer);
            refreshDebounceTimer = setTimeout(refreshData, 300);
        }

        /**
         * 异步获取单个指标数据
         * @param {string} metricName 指标名称
         * @param {string} dimension 维度
         * @param {string} startTime 开始时间
         * @param {string} endTime 结束时间
         * @returns {Promise} 包含指标值的Promise
         */
        async function fetchMetric(metricName, dimension, startTime, endTime) {
            const interval = document.getElementById('interval').value;
            const apiUrl = `/esa/traffic?name=${encodeURIComponent(metricName)}&dimension=${encodeURIComponent(dimension)}&interval=${encodeURIComponent(interval)}&startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                let rawValue = null;
                let foundData = false;

                if (data && Array.isArray(data.Data) && data.Data.length > 0) {
                    const metricEntry = data.Data.find(item => item.FieldName === metricName);
                    if (metricEntry && Array.isArray(metricEntry.DetailData) && metricEntry.DetailData.length > 0) {
                        rawValue = metricEntry.DetailData[0].Value;
                        foundData = true;
                    }
                }

                return {
                    metricName,
                    success: foundData,
                    value: rawValue
                };
            } catch (error) {
                console.error(`获取${metricName}数据失败:`, error);
                return {
                    metricName,
                    success: false,
                    value: null
                };
            } finally {
                updateProgressBar(); // 更新进度条
            }
        }

        /**
         * 更新DOM元素显示指标数据
         * @param {Object} result 指标请求结果
         */
        function updateMetricDisplay(result) {
            const targetElement = document.getElementById(result.metricName);
            if (!targetElement) return;

            if (!result.success || result.value === null) {
                targetElement.textContent = "无数据";
                return;
            }

            let displayValue;
            if (metricsConfig.bytesMetrics.includes(result.metricName)) {
                displayValue = formatBytes(result.value);
            } else if (metricsConfig.countMetrics.includes(result.metricName)) {
                displayValue = formatCount(result.value);
            } else {
                displayValue = result.value.toLocaleString();
            }

            targetElement.textContent = displayValue;
        }

        /**
         * 批量刷新所有指标数据
         */
        async function refreshData() {
            // 取消之前的请求
            currentRequests.forEach(abort => abort());
            currentRequests = [];

            // 初始化所有指标为加载中
            metricsConfig.fieldNames.forEach(metricName => {
                const el = document.getElementById(metricName);
                if (el) el.textContent = "加载中...";
            });

            const { startTime, endTime } = calculateTimeRange();
            const encodedDimension = metricsConfig.dimension;
            const allMetrics = metricsConfig.fieldNames;
            
            // 初始化进度条
            totalRequests = allMetrics.length;
            initProgressBar();

            // 创建所有请求的Promise
            const requestPromises = allMetrics.map(metricName => {
                // 创建AbortController用于取消请求
                const controller = new AbortController();
                const signal = controller.signal;
                currentRequests.push(() => controller.abort());

                // 包装fetchMetric，添加abort信号
                return fetchMetric(metricName, encodedDimension, startTime, endTime, signal);
            });

            // 并行执行所有请求
            const results = await Promise.all(requestPromises);
            
            // 更新所有DOM显示
            results.forEach(result => updateMetricDisplay(result));
            
            // 清空请求跟踪
            currentRequests = [];
        }

        // --- DOM加载完成后执行初始化逻辑 ---
        document.addEventListener('DOMContentLoaded', async () => {
            toggleCustomTimeInputs();
            refreshData();
        });
    </script>
</body>
</html>
